#!/bin/bash

# ==============================================================================
# Script Name: pushkey
# Description: Automatically append local SSH public key to a remote server.
# ==============================================================================

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo -e "Usage: $(basename "$0") [options] user@host"
    echo -e "Options:"
    echo -e "  -p <port>   Specify remote SSH port (default: 22)"
    echo -e "  -i <path>   Specify identity file"
    exit 1
}

REMOTE_PORT="22"
PUB_KEY_PATH=""

while getopts "p:i:h" opt; do
  case $opt in
    p) REMOTE_PORT=$OPTARG ;;
    i) PUB_KEY_PATH=$OPTARG ;;
    h) usage ;;
    *) usage ;;
  esac
done

shift $((OPTIND-1))
REMOTE_HOST=$1

if [ -z "$REMOTE_HOST" ]; then
    echo -e "${RED}[ERROR] Remote host not specified.${NC}"
    usage
fi

if [ -z "$PUB_KEY_PATH" ]; then
    if [ -f "$HOME/.ssh/id_ed25519.pub" ]; then
        PUB_KEY_PATH="$HOME/.ssh/id_ed25519.pub"
    elif [ -f "$HOME/.ssh/id_rsa.pub" ]; then
        PUB_KEY_PATH="$HOME/.ssh/id_rsa.pub"
    else
        echo -e "${RED}[ERROR] No SSH public key found.${NC}"
        exit 1
    fi
fi

PUB_KEY_CONTENT=$(cat "$PUB_KEY_PATH" | tr -d '\n')
echo -e "${GREEN}[INFO] Target: $REMOTE_HOST (Port: $REMOTE_PORT)${NC}"
echo -e "Connecting to remote server..."

ssh -p "$REMOTE_PORT" "$REMOTE_HOST" "
    mkdir -p ~/.ssh && \
    chmod 700 ~/.ssh && \
    touch ~/.ssh/authorized_keys && \
    chmod 600 ~/.ssh/authorized_keys && \
    if grep -qF '$PUB_KEY_CONTENT' ~/.ssh/authorized_keys; then
        echo 'EXISTS'
    else
        echo '$PUB_KEY_CONTENT' >> ~/.ssh/authorized_keys
        echo 'ADDED'
    fi
" | while read -r status; do
    if [[ "$status" == "EXISTS" ]]; then
        echo -e "${YELLOW}[SKIP] Key already exists on remote server.${NC}"
    elif [[ "$status" == "ADDED" ]]; then
        echo -e "${GREEN}[SUCCESS] Key added successfully.${NC}"
    fi
done

if [ $? -ne 0 ]; then
     echo -e "${RED}[ERROR] Connection failed or password incorrect.${NC}"
     exit 1
fi

#!/bin/bash

# =========================================================
# Screen Resolution & Scaling Tool
# =========================================================

# --- Configuration ---
STATE_FILE="$HOME/.cache/last_screen_state"
DEFAULT_CONFIG="$HOME/.screen"
mkdir -p "$(dirname "$STATE_FILE")"

# --- Detect Display ---
DISPLAY_NAME=$(xrandr | grep " connected" | head -n 1 | awk '{print $1}')

if [ -z "$DISPLAY_NAME" ]; then
    echo "[ERROR] No connected display detected."
    exit 1
fi

# =========================================================
# Logging
# =========================================================
function log_info()    { echo "[INFO]    $1"; }
function log_success() { echo "[SUCCESS] $1"; }
function log_warn()    { echo "[WARN]    $1"; }
function log_error()   { echo "[ERROR]   $1"; }

# =========================================================
# Functions
# =========================================================

function get_current_info() {
    local current_line=$(xrandr | grep -e "\*" | head -n 1)
    local res=$(echo "$current_line" | awk '{print $1}')
    local rate=$(echo "$current_line" | grep -oE '[0-9]+\.[0-9]+(\*|\+)+' | sed 's/[*+]//g' | head -n 1)
    
    local monitor_scale="N/A"
    local text_scale="N/A"

    if command -v gsettings &> /dev/null; then
        # Monitor Scale
        local raw_scale=$(gsettings get org.gnome.desktop.interface scaling-factor | awk '{print $NF}')
        if [[ "$raw_scale" == "0" ]]; then raw_scale=1; fi
        monitor_scale="$((raw_scale * 100))%"

        # Text Scale
        text_scale=$(gsettings get org.gnome.desktop.interface text-scaling-factor | awk '{print $NF}')
    fi

    echo ""
    echo "--- Display Status ---"
    echo "Monitor       : $DISPLAY_NAME"
    echo "Resolution    : $res"
    echo "Refresh Rate  : ${rate}Hz"
    echo "GNOME Scale   : $monitor_scale"
    echo "Text Factor   : $text_scale"
    echo "----------------------"
    echo ""
}

function save_current_state() {
    local current_line=$(xrandr | grep -e "\*" | head -n 1)
    local res=$(echo "$current_line" | awk '{print $1}')
    local rate=$(echo "$current_line" | grep -oE '[0-9]+\.[0-9]+(\*|\+)+' | sed 's/[*+]//g' | head -n 1)
    echo "$res $rate" > "$STATE_FILE"
}

function add_new_mode() {
    local w=$1; local h=$2; local r=$3
    if [[ -z "$r" ]]; then log_error "Usage: add <W> <H> <R>"; return 1; fi

    log_info "Calculating Modeline..."
    local cvt_out=$(cvt "$w" "$h" "$r")
    local params=$(echo "$cvt_out" | grep "Modeline" | sed -r 's/.*Modeline *"[^"]*" *//')

    if [ -z "$params" ]; then log_error "cvt failed to parse parameters."; return 1; fi

    local mode_name="${w}x${h}_${r}_User"
    xrandr --delmode "$DISPLAY_NAME" "$mode_name" 2>/dev/null
    xrandr --rmmode "$mode_name" 2>/dev/null

    log_info "Creating mode: $mode_name"
    xrandr --newmode "$mode_name" $params
    if [ $? -ne 0 ]; then log_error "Failed to create mode (xrandr --newmode)."; return 1; fi
    
    xrandr --addmode "$DISPLAY_NAME" "$mode_name"
    if [ $? -eq 0 ]; then log_success "Mode added: $mode_name"; else log_error "Failed to add mode to display."; fi
}

function switch_mode() {
    local input=$1; local rate=$2
    if [[ -z "$input" ]]; then log_error "Usage: switch <Name> [Rate]"; return 1; fi

    local target="$input"
    if ! xrandr | grep -q "[[:space:]]$target[[:space:]]"; then
        local match=$(xrandr | grep "${input}_" | grep "_User" | head -n 1 | awk '{print $1}')
        if [ -n "$match" ]; then target="$match"; log_info "Auto-matched: $target"; fi
    fi

    save_current_state
    log_info "Switching to: $target ..."
    
    if [ -n "$rate" ]; then
        xrandr --output "$DISPLAY_NAME" --mode "$target" --rate "$rate" --scale 1x1
    else
        xrandr --output "$DISPLAY_NAME" --mode "$target" --scale 1x1
    fi

    if [ $? -eq 0 ]; then log_success "Switched successfully."; else log_error "Switch failed."; fi
}

function set_scale() {
    local input=$1
    if [[ -z "$input" ]]; then log_error "Usage: scale <100|200|300>"; return 1; fi
    
    if [[ ! "$input" =~ ^[0-9]+$ ]]; then
         log_error "Scale must be an integer (e.g. 100, 200)."
         return 1
    fi

    local factor=$((input / 100))

    if [[ "$factor" -lt 1 ]]; then
        log_error "Scale too low. Minimum is 100."
        return 1
    fi

    if ! command -v gsettings &> /dev/null; then
        log_error "gsettings not found. GNOME environment required."; return 1; 
    fi

    # Disable conflicting fractional scaling features
    log_info "Disabling conflicting Fractional Scaling features..."
    gsettings set org.gnome.mutter experimental-features "[]" 2>/dev/null

    log_info "Setting GNOME scaling-factor to: $factor ($input%)"
    gsettings set org.gnome.desktop.interface scaling-factor "$factor"
    
    if [ $? -eq 0 ]; then log_success "Scale updated."; else log_error "Failed to set scale."; fi
}

function set_text_scale() {
    local factor=$1
    if [[ -z "$factor" ]]; then log_error "Usage: text-scale <factor> (e.g. 1.0, 1.25)"; return 1; fi

    if ! command -v gsettings &> /dev/null; then
        log_error "gsettings not found."; return 1; 
    fi

    log_info "Setting GNOME Text Scaling Factor to: $factor"
    gsettings set org.gnome.desktop.interface text-scaling-factor "$factor"
    
    if [ $? -eq 0 ]; then log_success "Text scale updated."; else log_error "Failed to set text scale."; fi
}

function restore_state() {
    if [ ! -f "$STATE_FILE" ]; then log_error "No history file found."; exit 1; fi
    read l_res l_rate < "$STATE_FILE"
    log_info "Restoring: $l_res @ ${l_rate}Hz"
    xrandr --output "$DISPLAY_NAME" --mode "$l_res" --rate "$l_rate" --scale 1x1
    if [ $? -eq 0 ]; then log_success "Restored."; fi
}

function load_config() {
    local file="${1:-$DEFAULT_CONFIG}"
    if [ ! -f "$file" ]; then log_error "Config file not found: $file"; return 1; fi
    log_info "Loading configuration: $file"
    while read -r line || [ -n "$line" ]; do
        [[ "$line" =~ ^#.*$ ]] && continue
        [[ -z "${line// }" ]] && continue
        read -r cmd args <<< "$line"
        case "$cmd" in
            add)        add_new_mode $args ;;
            switch)     switch_mode $args ;;
            scale)      set_scale $args ;;
            text-scale) set_text_scale $args ;;
            *)          log_warn "Unknown command: $cmd" ;;
        esac
    done < "$file"
    log_success "Configuration loaded."
}

# =========================================================
# Main
# =========================================================

case "$1" in
    info)       get_current_info ;;
    add)        add_new_mode "$2" "$3" "$4" ;;
    switch)     switch_mode "$2" "$3" ;;
    scale)      set_scale "$2" ;;
    text-scale) set_text_scale "$2" ;;
    restore)    restore_state ;;
    load)       load_config "$2" ;;
    *)
        echo "Usage: $(basename "$0") [COMMAND]"
        echo ""
        echo "Commands:"
        echo "  info               Show current status"
        echo "  add <W> <H> <R>    Add custom resolution"
        echo "  switch <Name>      Switch resolution"
        echo "  scale <Pct>        Set Integer Scale (100, 200, 300)"
        echo "  text-scale <Flt>   Fine-tune text size (e.g. 1.0, 1.25)"
        echo "  restore            Revert to previous resolution"
        echo "  load [File]        Load config (Default: ~/.screen)"
        echo ""
        exit 1
        ;;
esac

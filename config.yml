meta:
  name: "Chi Setup"
  ver: "1.0.0"

vars:
  profile: "desktop"
  email: "137579437@qq.com"
  username: "Kie-Chi"
  conda_path: "{{.vars.home}}/miniconda3"
  omz_path: "{{.vars.home}}/.oh-my-zsh"
  maple_ver: "v7.8"
  yesplaymusic_ver: "v0.4.10"
  font_size_gnome: "11"
  tilix_theme_name: "Dracula"
  tilix_theme_url: "https://raw.githubusercontent.com/dracula/tilix/master/Dracula.json"
  wechat_url: "https://dldir1v6.qq.com/weixin/Universal/Linux/WeChatLinux_x86_64.deb"
  snipaste_url: "https://dl.snipaste.com/linux"
  # Tilix Quake
  key_quake:  "custom-tilix-quake|Tilix Quake|tilix --quake|F12"
  # Tilix Normal
  key_norm:   "custom-tilix-normal|Tilix|tilix|<Control><Alt>t"
  # Chrome
  key_chrome: "google-chrome|Chrome|google-chrome-stable|F11"
  # Btop
  key_btop:   "btop|Btop|tilix -e btop|<Control><Alt>Backspace"
  local_utils: "scrctl|spk|ppack"
  rime_config_path: "{{.vars.home}}/.local/share/fcitx5/rime"
  
  # Optional Select
  if_ddns: true

# Some Inline Help Function
scripts:
  # -----------------------------------------------------------
  # Func: wrap
  # Param: $1=FuncName, $2=ParamsKey
  # Desc: Wrap 
  # -----------------------------------------------------------
  wrap: |
    #!/bin/sh
    FUNC="$1"
    RAW="$2"
    if [ -z "$FUNC" ] || [ -z "$RAW" ]; then
      echo "Usage: wrap <func> <string_with_pipes>"
      exit 1
    fi

    OLD_IFS="$IFS"
    IFS='|'
    set -f
    set -- $RAW
    set +f
    IFS="$OLD_IFS"
    "$FUNC" "$@"

  # -----------------------------------------------------------
  # Func: map
  # Param: $1=CommandPrefix, $2=ListString(Pipe separated)
  # Desc: Split the list and run Command on EACH item.
  #       If any execution fails, map exits with 1.
  # -----------------------------------------------------------
  map: |
    #!/bin/sh
    CMD="$1"
    RAW="$2"

    if [ -z "$CMD" ] || [ -z "$RAW" ]; then
      echo "Usage: map <cmd> <pipe_separated_list>"
      exit 1
    fi

    OLD_IFS="$IFS"
    IFS='|'
    set -f
    set -- $RAW
    set +f
    IFS="$OLD_IFS"

    for item in "$@"; do
      if ! $CMD "$item"; then
        echo "Map failed on item: $item"
        exit 1
      fi
    done
    exit 0

  # -----------------------------------------------------------
  # Func: set-gnome-key
  # Param: $1=ID, $2=Name, $3=Command, $4=Binding
  # Desc: Set a keyshort for GNOME Desktop
  # -----------------------------------------------------------
  set-gnome-key: |
    #!/bin/sh
    set -e # Exit if error

    ID="$1"
    NAME="$2"
    CMD="$3"
    BINDING="$4"

    if [ -z "$ID" ] || [ -z "$CMD" ]; then
      echo "Usage: set-gnome-key <ID> <NAME> <CMD> <BINDING>"
      exit 1
    fi

    # Block Wait
    LOCK="/tmp/dotb_gnome_keybindings.lock"
    exec 9>"$LOCK"
    flock -x 9

    SCHEMA="org.gnome.settings-daemon.plugins.media-keys"
    PATH_PREFIX="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings"
    KEY_PATH="$PATH_PREFIX/$ID/"
    FULL_SCHEMA="${SCHEMA}.custom-keybinding:${KEY_PATH}"
    echo "Configuring GNOME Key: [$ID] $NAME -> $BINDING"
    gsettings set "$FULL_SCHEMA" name "$NAME"
    gsettings set "$FULL_SCHEMA" command "$CMD"
    gsettings set "$FULL_SCHEMA" binding "$BINDING"
    CURRENT_LIST=$(gsettings get "$SCHEMA" custom-keybindings)
    if echo "$CURRENT_LIST" | grep -Fq "$KEY_PATH"; then
      exit 0
    fi
    if [ "$CURRENT_LIST" = "@as []" ] || [ "$CURRENT_LIST" = "[]" ]; then
      NEW_LIST="['$KEY_PATH']"
    else
      NEW_LIST=$(echo "$CURRENT_LIST" | sed "s|]$|, '$KEY_PATH']|")
    fi
    gsettings set "$SCHEMA" custom-keybindings "$NEW_LIST"

  # -----------------------------------------------------------
  # Func: check-gnome-key
  # Params: $1=ID, $2=IgnoredName, $3=Command, $4=Binding
  # Desc: Check if the keyshort is set correctly
  # -----------------------------------------------------------
  check-gnome-key: |
    #!/bin/sh
    # 0 -> Success
    # 1 -> Fail
    ID="$1"
    IGNORE_NAME="$2"
    EXPECTED_CMD="$3"
    EXPECTED_BINDING="$4"
    SCHEMA="org.gnome.settings-daemon.plugins.media-keys"
    PATH_PREFIX="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings"
    KEY_PATH="$PATH_PREFIX/$ID/"
    FULL_SCHEMA="${SCHEMA}.custom-keybinding:${KEY_PATH}"
    LIST=$(gsettings get "$SCHEMA" custom-keybindings)
    if ! echo "$LIST" | grep -Fq "$KEY_PATH"; then
      exit 1 # No Keyshort
    fi
    ACTUAL_CMD=$(gsettings get "$FULL_SCHEMA" command)
    if [ "$ACTUAL_CMD" != "'$EXPECTED_CMD'" ]; then
      exit 1 # Cmd Error
    fi
    if [ -n "$EXPECTED_BINDING" ]; then
      ACTUAL_BINDING=$(gsettings get "$FULL_SCHEMA" binding)
      if [ "$ACTUAL_BINDING" != "'$EXPECTED_BINDING'" ]; then
        exit 1 # Bind Error
      fi
    fi
    exit 0 

  # -----------------------------------------------------------
  # Func: git-ensure
  # Param: $1=Path, $2=RepoURL
  # Desc: Clone git repo only if path does not exist
  # -----------------------------------------------------------
  git-ensure: |
    #!/bin/sh
    PATH_DIR="$1"
    REPO_URL="$2"

    if [ -d "$PATH_DIR" ]; then
      echo "Repo exists at $PATH_DIR, skipping..."
      exit 0
    fi

    echo "Cloning $REPO_URL -> $PATH_DIR"
    mkdir -p "$(dirname "$PATH_DIR")"
    git clone --depth=1 "$REPO_URL" "$PATH_DIR"
  
  # -----------------------------------------------------------
  # Func: apt-ri
  # Param: $1=URL
  # Desc: Download and install a .deb file via apt
  # -----------------------------------------------------------
  apt-ri: |
    #!/bin/sh
    URL="$1"
    TMP_FILE="/tmp/install_$(date +%s).deb"
    echo "Downloading $URL..."
    curl -L -o "$TMP_FILE" "$URL"

    echo "Installing via apt..."
    sudo apt-get install -y "$TMP_FILE"

    rm -f "$TMP_FILE"
    echo "Done."
 
  # -----------------------------------------------------------
  # Func: ex
  # Param: $@ = Files...
  # Desc: chmod +x for multiple files
  # -----------------------------------------------------------
  ex: |
    #!/bin/sh
    for file in "$@"; do
      if [ -f "$file" ] && [ ! -x "$file" ]; then
        echo "chmod +x $file"
        chmod +x "$file"
      fi
    done

  # Not Public Func, Not Suitable For Every Task
  # -----------------------------------------------------------
  # Func: is-local-x
  # Param: $1 = File
  # Desc: check executable for multiple file
  # -----------------------------------------------------------
  is-local-x: |
    #!/bin/sh
    [ -x "{{.vars.home}}/.local/bin/$1" ]

  # -----------------------------------------------------------
  # Func: en-local-x
  # Param: $1 = File
  # Desc: en executable for multiple file
  # -----------------------------------------------------------
  en-local-x: |
    #!/bin/sh
    echo "chmod +x -> {{.vars.home}}/.local/bin/$1"
    chmod +x "{{.vars.home}}/.local/bin/$1"

  # -----------------------------------------------------------
  # Func: is-local-e
  # Param: $1 = File
  # Desc: check if file exits
  # -----------------------------------------------------------
  is-local-f: |
    #!/bin/sh
    [ -f "{{.vars.home}}/.local/bin/$1" ]
  
  # -----------------------------------------------------------
  # Func: lk-local
  # Param: $1 = File
  # Desc: symbolink the file from .dotfiles/resource
  # -----------------------------------------------------------
  lk-local: |
    #!/bin/sh
    if [ ! -f "{{.vars.home}}/.local/bin/$1" ]; then
      echo "link {{.vars.home}}/.local/bin/$1 -> {{.vars.home}}/.dotfiles/resource/$1"
      ln -sf "{{.vars.home}}/.dotfiles/resource/$1" "{{.vars.home}}/.local/bin/$1"
    fi
  
# My Package List
pkgs:
  - git
  - curl
  - wget
  - zsh
  - tmux
  - vim
  - btop
  - htop
  - unzip
  - openssh-server
  - ssh
  - jq
  - tree
  - name: copyq
    check: '[ "{{.vars.profile}}" != "desktop" ] || ({{.super.check}})'
  - name: tilix
    check: '[ "{{.vars.profile}}" != "desktop" ] || ({{.super.check}})'
  - name: fontconfig
    check: '[ "{{.vars.profile}}" != "desktop" ] || ({{.super.check}})'
  - name: pavucontrol
    check: '[ "{{.vars.profile}}" != "desktop" ] || ({{.super.check}})'
  - name: libfuse2
    check: '[ "{{.vars.profile}}" != "desktop" ] || ! command -v apt-get || dpkg -s libfuse2 || dpkg -s libfuse2t64'
    manager: apt
  - name: apt-transport-https
    check: '[ "{{.vars.profile}}" != "desktop" ] || ! command -v apt-get || ({{.super.check}})'
    manager: apt
  - name: xclip
    ignore: true
  - name: xsel
    ignore: true
  - name: build-essential
    manager: apt
    check: '! command -v apt-get || ({{.super.check}})'
  - name: dconf-cli
    check: '[ "{{.vars.profile}}" != "desktop" ] || ! command -v apt-get || ({{.super.check}})'
    manager: apt
  
  # Sdk Man
  - name: sdk
    check: '! command -v bash || zsh -c ". {{.vars.home}}/.zshrc && sdk version"'
    exec: |
      curl -s "https://get.sdkman.io" | bash
      bash -c "source '{{.vars.home}}/.sdkman/bin/sdkman-init.sh'"

  # Docker
  - name: docker
    check: "docker --version"
    exec: |
      curl -fsSL https://get.docker.com | sh
    post: |
      # å…è®¸å½“å‰ç”¨æˆ·ä¸åŠ  sudo ä½¿ç”¨ docker
      sudo usermod -aG docker $USER || true
      sudo systemctl enable docker || true
      sudo systemctl start docker || true
    deps: [curl]

  # Miniconda
  - name: miniconda
    check: "{{.vars.conda_path}}/bin/conda --version"
    pre: "mkdir -p /tmp/conda_install"
    exec: |
      wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/mc.sh
      bash /tmp/mc.sh -b -u -p {{.vars.conda_path}}
    post: |
      # åˆå§‹åŒ– Shell
      {{.vars.conda_path}}/bin/conda init zsh
      {{.vars.conda_path}}/bin/conda config --set auto_activate_base false
    deps: [wget, curl]
  # Oh-My-Zsh
  - name: oh-my-zsh
    deps: [git, zsh]
    check: "[ -d {{.vars.omz_path}} ]"
    exec: git-ensure "{{.vars.omz_path}}" "https://github.com/ohmyzsh/ohmyzsh.git"

  # Zsh Autosuggestions
  - name: zsh-autosuggestions
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/plugins/zsh-autosuggestions ]"
    exec: git-ensure "{{.vars.omz_path}}/custom/plugins/zsh-autosuggestions" "https://github.com/zsh-users/zsh-autosuggestions"

  # Zsh Syntax Highlighting
  - name: zsh-syntax-highlighting
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/plugins/zsh-syntax-highlighting ]"
    exec: git-ensure "{{.vars.omz_path}}/custom/plugins/zsh-syntax-highlighting" "https://github.com/zsh-users/zsh-syntax-highlighting.git"

  # Powerlevel10k
  - name: p10k
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/themes/powerlevel10k ]"
    exec: git-ensure "{{.vars.omz_path}}/custom/themes/powerlevel10k" "https://github.com/romkatv/powerlevel10k.git"

  # Vim Vundle & Plugins
  - name: vundle
    deps: [git, vim]
    check: "[ -d {{.vars.home}}/.vim/bundle/Vundle.vim ]"
    exec: git-ensure "{{.vars.home}}/.vim/bundle/Vundle.vim" "https://github.com/VundleVim/Vundle.vim.git"

  # Vim Plugins
  - name: vim-plugins
    deps: [vundle]
    # æ£€æŸ¥ bundle ç›®å½•ä¸‹æ˜¯å¦æœ‰é™¤äº† Vundle ä»¥å¤–çš„æ–‡ä»¶å¤¹ï¼Œç®€å•åˆ¤æ–­æ˜¯å¦å®‰è£…è¿‡æ’ä»¶
    check: "[ $(ls -A {{.vars.home}}/.vim/bundle | grep -v Vundle.vim | wc -l) -gt 0 ]"
    exec: "vim +PluginInstall +qall"

  # Fcitx5, replace IBus
  - name: fcitx
    check: '[ "{{.vars.profile}}" != "desktop" ] || ({{.super.check}})'
    map:
      pacman: fcitx5-im fcitx5-rime fcitx5-configtool fcitx5-chinese-addons
      dnf: fcitx5 fcitx5-rime fcitx5-configtool fcitx5-autostart
      apt: fcitx5 fcitx5-rime fcitx5-config-qt fcitx5-frontend-gtk2 fcitx5-frontend-gtk3 fcitx5-frontend-qt5
      def: fcitx5 fcitx5-rime fcitx5-config-qt

  # Google Chrome Browser
  - name: chrome
    check: '[ "{{.vars.profile}}" != "desktop" ] || command -v google-chrome-stable'
    exec: |
      # For Debian/Ubuntu based systems
      if command -v apt-get &> /dev/null; then
        echo "Detected apt package manager. Installing Google Chrome..."
        wget -O /tmp/google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y /tmp/google-chrome.deb
        rm /tmp/google-chrome.deb

      # For Fedora/RHEL based systems
      elif command -v dnf &> /dev/null; then
        echo "Detected dnf package manager. Installing Google Chrome..."
        sudo dnf install -y fedora-workstation-repositories
        sudo dnf config-manager --set-enabled google-chrome
        sudo dnf install -y google-chrome-stable

      # For Arch Linux based systems
      elif command -v pacman &> /dev/null; then
        echo "Detected pacman package manager. Installing Google Chrome from AUR..."
        if ! command -v yay &> /dev/null; then
          echo "Error: 'yay' is not installed. Please install an AUR helper." >&2
          exit 1
        fi
        yay -S --noconfirm google-chrome
      
      else
        echo "Unsupported package manager. Cannot install Google Chrome." >&2
        exit 1
      fi 

  - name: yesplaymusic
    deps: [wget]
    check: '[ "{{.vars.profile}}" != "desktop" ] || ! command -v apt-get || dpkg -s yesplaymusic'
    exec: |
      VER="{{.vars.yesplaymusic_ver}}"
      CLEAN_VER="${VER#v}"
      URL="https://github.com/qier222/YesPlayMusic/releases/download/${VER}/yesplaymusic_${CLEAN_VER}_amd64.deb"
      apt-ri "$URL"

files:
  - id: gitconfig
    src: "conf/gitconfig.tpl"
    dest: "{{.vars.home}}/.gitconfig"
    tpl: true
    override: true

  - id: zshrc
    src: "conf/zshrc"
    dest: "{{.vars.home}}/.zshrc"
    override: true
    deps: [zsh]
  
  - id: zshrc-fcitx5
    src: "conf/fcitx5.zsh"
    dest: "{{.vars.home}}/.zshrc"
    append: true
    deps: [zshrc]
    check: '[ "{{.vars.profile}}" != "desktop" ]'
  
  - id: fcitx-profile
    src: "conf/fcitx5_profile"
    dest: "{{.vars.home}}/.config/fcitx5/profile"
    deps: [fcitx]
    override: true
    override_if: "test ! -f {{.vars.home}}/.config/fcitx5/profile || ! grep -q 'Name=rime' {{.vars.home}}/.config/fcitx5/profile"
    check: '[ "{{.vars.profile}}" != "desktop" ]'

  - id: fcitx-ui
    src: "conf/fcitx5_ui.conf"
    dest: "{{.vars.home}}/.config/fcitx5/conf/classicui.conf"
    deps: [fcitx]
    override: true
    check: '[ "{{.vars.profile}}" != "desktop" ]'
  
  - id: rime-custom
    src: "conf/rime.yaml"
    dest: "{{.vars.home}}/.local/share/fcitx5/rime/default.custom.yaml"
    deps: [fcitx]
    override: true
    check: '[ "{{.vars.profile}}" != "desktop" ]'

  - id: rime-origin
    src: "conf/rime.yaml"
    dest: "{{.vars.home}}/.local/share/fcitx5/rime/default.yaml"
    deps: [fcitx]
    override: true
    check: '[ "{{.vars.profile}}" != "desktop" ]'

  - src: "conf/p10k.zsh"
    dest: "{{.vars.home}}/.p10k.zsh"
    override: true

  - src: "conf/vimrc"
    dest: "{{.vars.home}}/.vimrc"
    override: true

  - src: "conf/wechat.desktop"
    dest: "{{.vars.home}}/.config/autostart/wechat.desktop"
    tpl: true
    deps: [wechat]
    check: '[ "{{.vars.profile}}" != "desktop" ]'
  
  - src: "conf/snipaste.desktop"
    dest: "{{.vars.home}}/.config/autostart/snipaste.desktop"
    tpl: true
    deps: [snipaste]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -f "{{.vars.home}}/.config/autostart/snipaste.desktop" ]'

  - id: ssh-config
    src: "conf/ssh_config"
    dest: "{{.vars.home}}/.ssh/config"
    deps: [ssh-key]
    override: true

  - id: sunshine-desktop
    src: "conf/sunshine.desktop"
    dest: "{{.vars.home}}/.config/autostart/sunshine.desktop"
    deps: [sunshine]
    check: '[ "{{.vars.profile}}" != "desktop" ]'
    override: true

  ## Optional for linux
  - id: ddns-conf
    src: "conf/ddns.yml"
    deps: [ddns-go]
    dest: "{{.vars.home}}/.ddns_go_config.yml"
    check: '[ {{.vars.if_ddns}} != "true" ]'
    tpl: true
    override: true

tasks:
  - id: zsh-shell
    deps: [zsh, oh-my-zsh]
    check: '[ "$SHELL" = "$(which zsh)" ]'
    run: "sudo chsh -s $(which zsh) {{.vars.user}}"

  - id: welcome-msg
    deps: [p10k, vim-plugins]
    run: "echo 'ðŸŽ‰ Environment Setup for Kie-Chi Complete! Please relogin.'"

  - id: tilix-quake
    deps: [init-tilix]
    check: '[ "{{.vars.profile}}" != "desktop" ] || wrap check-gnome-key "{{.vars.key_quake}}"'
    run: wrap set-gnome-key "{{.vars.key_quake}}"

  - id: tilix-norm
    deps: [init-tilix]
    check: '[ "{{.vars.profile}}" != "desktop" ] || wrap check-gnome-key "{{.vars.key_norm}}"'
    run: wrap set-gnome-key "{{.vars.key_norm}}"

  - id: ssh-key
    deps: [git]
    check: "[ -f {{.vars.home}}/.ssh/id_ed25519 ]"
    run: |
      echo "Generating SSH Key for {{.vars.email}}..."
      mkdir -p {{.vars.home}}/.ssh
      chmod 700 {{.vars.home}}/.ssh
      ssh-keygen -t ed25519 -C "{{.vars.email}}" -f {{.vars.home}}/.ssh/id_ed25519 -N ""

      eval "$(ssh-agent -s)"
      ssh-add {{.vars.home}}/.ssh/id_ed25519

      echo "--------------------------------------------------------"
      echo "PUBLIC KEY GENERATED:"
      echo "--------------------------------------------------------"
      cat {{.vars.home}}/.ssh/id_ed25519.pub
      echo "--------------------------------------------------------"

  - id: remove-snap
    check: '[ "{{.vars.profile}}" != "desktop" ] || ! command -v snap'
    run: |
      echo "Starting Snap Removal..."
      if command -v snap &> /dev/null; then
          echo "Removing installed snaps (This may take a while)..."
          
          for i in {1..3}; do
              LANG=C snap list | awk 'NR>1 {print $1}' | while read -r snapname; do
                  sudo snap remove --purge "$snapname" 2>/dev/null || true
              done
          done
      fi

      echo "All user snaps removed. Stopping services..."

      sudo systemctl stop snapd.socket || true
      sudo systemctl stop snapd.service || true
      sudo systemctl disable snapd.socket || true
      sudo systemctl disable snapd.service || true
      
      echo "Purging snapd via APT..."
      sudo apt-get autoremove --purge -y snapd gnome-software-plugin-snap
      
      rm -rf {{.vars.home}}/snap
      sudo rm -rf /var/cache/snapd
      sudo rm -rf /var/lib/snapd
      
      echo "Snap Removed Successfully." 
  
  - id: block-snap
    deps: [remove-snap]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -f /etc/apt/preferences.d/nosnap.pref ] || ! command -v apt-get'
    run: |
      echo "Blocking Snap re-installation..."
      cat <<EOF | sudo tee /etc/apt/preferences.d/nosnap.pref
      Package: snapd
      Pin: release a=*
      Pin-Priority: -1
      EOF
      echo "Snap is now blocked via APT pinning."
 
  - id: maple-mono
    deps: [wget, unzip, fontconfig]
    check: '[ "{{.vars.profile}}" != "desktop" ] || fc-list | grep -i "Maple Mono NF CN"'
    run: |
      echo "Installing Maple Mono NF CN {{.vars.maple_ver}}..."
      mkdir -p {{.vars.home}}/.local/share/fonts/maple
      wget "https://github.com/subframe7536/Maple-font/releases/download/{{.vars.maple_ver}}/MapleMono-NF-CN.zip" -O /tmp/maple.zip
      unzip -o /tmp/maple.zip -d /tmp/maple_ext
      find /tmp/maple_ext -name "*MapleMono-NF-CN*.ttf" -exec cp {} {{.vars.home}}/.local/share/fonts/maple/ \;

      rm -rf /tmp/maple.zip /tmp/maple_ext
      fc-cache -fv
      echo "Font installed."

  - id: gnome-maple
    deps: [maple-mono]
    check: |
      [ "{{.vars.profile}}" != "desktop" ] || ( \
        CURRENT=$(gsettings get org.gnome.desktop.interface monospace-font-name) && \
        [ "$CURRENT" = "'Maple Mono NF CN {{.vars.font_size_gnome}}'" ] \
      )
    run: |
      SIZE="{{.vars.font_size_gnome}}"
      echo "Setting GNOME Monospace to size $SIZE..."
      gsettings set org.gnome.desktop.interface monospace-font-name "Maple Mono NF CN $SIZE" 
  
  - id: sunshine
    deps: [curl, wget] 
    check: "command -v sunshine"
    run: |
      echo "Installing Sunshine..."

      if command -v apt-get >/dev/null; then
        echo "Detected Debian/Ubuntu..."
        
        if [ -f /etc/apt/sources.list.d/sunshine.list ]; then
           echo "Removing broken Sunshine apt source..."
           sudo rm -f /etc/apt/sources.list.d/sunshine.list
           sudo apt-get update -qq 
        fi

        OS_NAME=$(lsb_release -is | tr '[:upper:]' '[:lower:]') # ä¾‹å¦‚: ubuntu
        OS_VERSION=$(lsb_release -rs)
        ARCH=$(dpkg --print-architecture)
        echo "Install for $OS_NAME:$OS_VERSION@$ARCH" 
        echo "Looking for Sunshine release for: $OS_NAME-$OS_VERSION ($ARCH)"

        DOWNLOAD_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest \
            | grep "browser_download_url" \
            | grep ".deb" \
            | grep -i "${OS_NAME}-${OS_VERSION}-${ARCH}" \
            | cut -d '"' -f 4)

        if [ -z "$DOWNLOAD_URL" ]; then
            echo "Error: Could not auto-detect a compatible .deb package for your system."
            echo "Please install manually from https://github.com/LizardByte/Sunshine/releases"
            exit 1
        fi

        echo "Downloading: $DOWNLOAD_URL"
        wget -O /tmp/sunshine_install.deb "$DOWNLOAD_URL"
        echo "Installing .deb package..."
        sudo apt-get install -y /tmp/sunshine_install.deb
        rm -f /tmp/sunshine_install.deb

      elif command -v pacman >/dev/null; then
        echo "Detected Arch Linux..."
        if command -v yay >/dev/null; then
           yay -S --noconfirm sunshine
        else
           sudo pacman -S --noconfirm sunshine
        fi
      fi
      
      mkdir -p {{.vars.home}}/.config/systemd/user/sunshine.service.d/
      cat <<EOF > {{.vars.home}}/.config/systemd/user/sunshine.service.d/override.conf
      [Unit]
      After=graphical-session.target
      
      [Service]
      ExecStartPre=
      Environment=DISPLAY=:0
      Environment=XAUTHORITY={{.vars.home}}/.Xauthority
      Restart=always
      RestartSec=5
      EOF

      echo 'KERNEL=="uinput", SUBSYSTEM=="misc", OPTIONS+="static_node=uinput", TAG+="uaccess"' | sudo tee /etc/udev/rules.d/85-sunshine-input.rules
      sudo udevadm control --reload-rules
      sudo udevadm trigger

      if ! groups {{.vars.user}} | grep -q "input"; then
         sudo usermod -aG input,video,render {{.vars.user}}
         echo "User added to groups. REBOOT REQUIRED."
      fi
      echo "Enabling Sunshine service..."
      systemctl --user daemon-reload
      systemctl --user enable sunshine
      systemctl --user start sunshine

      echo "Sunshine installed. Access it via https://localhost:47990"

  - id: zsh-copydir
    deps: [oh-my-zsh]
    check: "[ -f {{.vars.omz_path}}/custom/plugins/copydir/copydir.plugin.zsh ]"
    run: |
      echo "Installing copydir plugin to custom directory..."
      mkdir -p {{.vars.omz_path}}/custom/plugins/copydir

      wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/plugins/copypath/copypath.plugin.zsh \
        -O {{.vars.omz_path}}/custom/plugins/copydir/copydir.plugin.zsh

      echo "Done. Please ensure 'copypath' is in your .zshrc plugins list."

  - id: init-fcitx
    deps: [fcitx, fix-rime, fcitx-profile, fcitx-ui]
    check: '[ "{{.vars.profile}}" != "desktop" ] || pgrep fcitx5 > /dev/null'
    on:
      fail: run
    run: |
      if command -v im-config >/dev/null; then
        sudo im-config -n fcitx5
      fi
      
      killall ibus-daemon || true
      killall fcitx5 || true
      nohup fcitx5 -d --replace > /dev/null 2>&1 &
      sleep 2
      echo "Fcitx5 started."
  
  - id: init-tilix
    deps: [dconf-cli]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -n "$(dconf read /com/gexperts/Tilix/default-profile)" ]'
    run: |
      echo "Initializing Tilix configuration manually..."
      EXISTING_ID=$(dconf list /com/gexperts/Tilix/profiles/ | head -n1 | tr -d "/")

      if [ -n "$EXISTING_ID" ]; then
        echo "Found existing profile: $EXISTING_ID"
        FINAL_UUID="$EXISTING_ID"
      else
        echo "No existing profile found. Generating new UUID..."
        FINAL_UUID="2b7c4080-0ddd-46c5-8f23-563fd3ba789d"
        dconf write "/com/gexperts/Tilix/profiles/$FINAL_UUID/visible-name" "'Default'"
        dconf write "/com/gexperts/Tilix/profiles/$FINAL_UUID/automatic-switch-profile" "false"
      fi
      echo "Setting default profile to: $FINAL_UUID"
      dconf write /com/gexperts/Tilix/default-profile "'$FINAL_UUID'"
  
  - id: tilix-theme-dracula
    deps: [wget, dconf-cli, jq]
    check: |
      [ "{{.vars.profile}}" != "desktop" ] || ( \
        PROFILE=$(dconf read /com/gexperts/Tilix/default-profile | tr -d "'") && \
        [ -n "$PROFILE" ] && \
        BG=$(dconf read "/com/gexperts/Tilix/profiles/$PROFILE/background-color" | tr -d "'") && \
        [ "$BG" = "#282936" ] \
      )
    run: |
      echo "Manually injecting Dracula theme colors..."

      mkdir -p /tmp/tilix_theme
      wget -qO /tmp/tilix_theme/Dracula.json "https://raw.githubusercontent.com/dracula/tilix/master/Dracula.json"
      JSON_FILE="/tmp/tilix_theme/Dracula.json"

      PROFILE_ID=$(dconf read /com/gexperts/Tilix/default-profile | tr -d "'")
      if [ -z "$PROFILE_ID" ]; then echo "Error: No Profile ID found."; exit 1; fi

      BASE_PATH="/com/gexperts/Tilix/profiles/$PROFILE_ID"
      echo "Target Profile: $PROFILE_ID"

      BG_COLOR="'$(jq -r '.["background-color"]' $JSON_FILE)'"
      FG_COLOR="'$(jq -r '.["foreground-color"]' $JSON_FILE)'"
      CURSOR_COLOR="'$(jq -r '.["cursor-background-color"]' $JSON_FILE)'"

      echo "Setting Background: $BG_COLOR"
      dconf write "$BASE_PATH/background-color" "$BG_COLOR"
      dconf write "$BASE_PATH/foreground-color" "$FG_COLOR"
      dconf write "$BASE_PATH/cursor-background-color" "$CURSOR_COLOR"

      PALETTE_STR=$(jq -c '.palette' $JSON_FILE | sed "s/\"/'/g")

      echo "Setting Palette..."
      dconf write "$BASE_PATH/palette" "$PALETTE_STR"

      dconf write "$BASE_PATH/use-theme-colors" "false"
      rm -rf /tmp/tilix_theme
      echo "Dracula theme injection complete!"
 
  - id: fix-rime
    deps: [fcitx]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -f {{.vars.home}}/.local/share/fcitx5/rime/luna_pinyin.schema.yaml ]'
    run: |
      echo "Copying system Rime data..."
      if [ -d /usr/share/rime-data ]; then
        cp -r /usr/share/rime-data/* {{.vars.home}}/.local/share/fcitx5/rime/
      elif [ -d /usr/share/rime-data ]; then
         cp -r /usr/share/rime-data/* {{.vars.home}}/.local/share/fcitx5/rime/
      fi
  
  - id: use-fcitx
    deps: [fcitx]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -f {{.vars.home}}/.config/autostart/org.fcitx.Fcitx5.desktop ]'
    run: "mkdir -p {{.vars.home}}/.config/autostart && cp /usr/share/applications/org.fcitx.Fcitx5.desktop {{.vars.home}}/.config/autostart/"

  - id: vscode
    deps: [wget, curl, apt-transport-https]
    check: "command -v code"
    run: |
      echo "Installing Visual Studio Code..."

      # Debian
      if command -v apt-get >/dev/null; then
        echo "Detected Debian/Ubuntu..."
        
        wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
        sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
        rm -f packages.microsoft.gpg

        echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null

        sudo apt-get update
        sudo apt-get install -y code
      
      # Arch
      elif command -v pacman >/dev/null; then
        echo "Detected Arch Linux..."
        if command -v yay >/dev/null; then
           yay -S --noconfirm visual-studio-code-bin
        else
           sudo pacman -S --noconfirm code
        fi
      fi
      echo "VS Code installation complete."

  - id: wechat
    check: '[ "{{.vars.profile}}" != "desktop" ] || dpkg -s wechat || dpkg -s com.tencent.wechat'
    run: apt-ri "{{.vars.wechat_url}}"

  - id: snipaste
    deps: [libfuse2]
    check: '[ "{{.vars.profile}}" != "desktop" ] || test -f {{.vars.home}}/.local/bin/snipaste'
    run: |
      mkdir -p {{.vars.home}}/.local/bin
      echo "Downloading Snipaste..."
      curl -L -o {{.vars.home}}/.local/bin/snipaste {{.vars.snipaste_url}}
      ex {{.vars.home}}/.local/bin/snipaste
      echo "Snipaste installed to ~/.local/bin/snipaste"

  - id: chrome-shortcut
    deps: [chrome]
    check: '[ "{{.vars.profile}}" != "desktop" ] || wrap check-gnome-key "{{.vars.key_chrome}}"'
    run: wrap set-gnome-key "{{.vars.key_chrome}}"

  - id: btop-shortcut
    deps: [btop]
    check: '[ "{{.vars.profile}}" != "desktop" ] || wrap check-gnome-key "{{.vars.key_btop}}"'
    run: wrap set-gnome-key "{{.vars.key_btop}}"
  
  - id: util-copy
    check: map is-local-f "{{.vars.local_utils}}"
    run: map lk-local "{{.vars.local_utils}}"

  - id: util-chmod
    deps: [util-copy]
    check: map is-local-x "{{.vars.local_utils}}"
    run: map en-local-x "{{.vars.local_utils}}"

  - id: rime-ice
    deps: [fcitx]
    check: '[ "{{.vars.profile}}" != "desktop" ] || [ -e {{.vars.rime_config_path}}/.rime-ice-installed ]'
    run: |
      set -e
      RIME_CONFIG_PATH="{{.vars.rime_config_path}}"
      RIME_ICE_TMP_PATH="$RIME_CONFIG_PATH/rime-ice"
      echo "Install to $RIME_CONFIG_PATH..."
      git-ensure "$RIME_ICE_TMP_PATH" "https://github.com/iDvel/rime-ice.git"
      rsync -av --remove-source-files "$RIME_ICE_TMP_PATH/" "$RIME_CONFIG_PATH/"
      touch "$RIME_CONFIG_PATH/.rime-ice-installed"
      echo "Rime Ice Installed."

  - id: ddns-go
    deps: []
    run: 

meta:
  name: "Chi Setup"
  ver: "1.0.0"

vars:
  email: "137579437@qq.com"
  username: "Kie-Chi"
  home: "/home/chi" 
  conda_path: "{{.vars.home}}/miniconda3"
  omz_path: "{{.vars.home}}/.oh-my-zsh"

# My Package List
pkgs:
  - git
  - curl
  - wget
  - zsh
  - tmux
  - vim
  - htop
  - unzip
  - openssh-server
  - ssh
  - tilix
  - name: build-essential
    manager: apt
    ignore: true  # Èùû Debian/Ubuntu Á≥ªÁªüÂèØÂøΩÁï•

  # Docker
  - name: docker
    check: "docker --version"
    exec: |
      curl -fsSL https://get.docker.com | sh
    post: |
      # ÂÖÅËÆ∏ÂΩìÂâçÁî®Êà∑‰∏çÂä† sudo ‰ΩøÁî® docker
      sudo usermod -aG docker $USER || true
      sudo systemctl enable docker || true
      sudo systemctl start docker || true
    deps: [curl]

  # Miniconda
  - name: miniconda
    check: "{{.vars.conda_path}}/bin/conda --version"
    pre: "mkdir -p /tmp/conda_install"
    exec: |
      wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/mc.sh
      bash /tmp/mc.sh -b -u -p {{.vars.conda_path}}
    post: |
      # ÂàùÂßãÂåñ Shell
      {{.vars.conda_path}}/bin/conda init zsh
      {{.vars.conda_path}}/bin/conda config --set auto_activate_base false
    deps: [wget, curl]
  # Oh-My-Zsh
  - name: oh-my-zsh
    deps: [git, zsh]
    check: "[ -d {{.vars.omz_path}} ]"
    exec: "git clone --depth=1 https://github.com/ohmyzsh/ohmyzsh.git {{.vars.omz_path}}"

  # Zsh Autosuggestions
  - name: zsh-autosuggestions
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/plugins/zsh-autosuggestions ]"
    exec: "git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions {{.vars.omz_path}}/custom/plugins/zsh-autosuggestions"

  # Zsh Syntax Highlighting
  - name: zsh-syntax-highlighting
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/plugins/zsh-syntax-highlighting ]"
    exec: "git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git {{.vars.omz_path}}/custom/plugins/zsh-syntax-highlighting"

  # Powerlevel10k
  - name: p10k
    deps: [oh-my-zsh]
    check: "[ -d {{.vars.omz_path}}/custom/themes/powerlevel10k ]"
    exec: "git clone --depth=1 https://github.com/romkatv/powerlevel10k.git {{.vars.omz_path}}/custom/themes/powerlevel10k"

  # Vim Vundle & Plugins
  - name: vundle
    deps: [git, vim]
    check: "[ -d {{.vars.home}}/.vim/bundle/Vundle.vim ]"
    exec: "git clone https://github.com/VundleVim/Vundle.vim.git {{.vars.home}}/.vim/bundle/Vundle.vim"

  # Vim Plugins
  - name: vim-plugins
    deps: [vundle]
    # Ê£ÄÊü• bundle ÁõÆÂΩï‰∏ãÊòØÂê¶ÊúâÈô§‰∫Ü Vundle ‰ª•Â§ñÁöÑÊñá‰ª∂Â§πÔºåÁÆÄÂçïÂà§Êñ≠ÊòØÂê¶ÂÆâË£ÖËøáÊèí‰ª∂
    check: "[ $(ls -A {{.vars.home}}/.vim/bundle | grep -v Vundle.vim | wc -l) -gt 0 ]"
    exec: "vim +PluginInstall +qall"


files:
  - src: "conf/gitconfig.tpl"
    dest: "{{.vars.home}}/.gitconfig"
    tpl: true
    force: true

  - src: "conf/zshrc"
    dest: "{{.vars.home}}/.zshrc"
    force: true

  - src: "conf/p10k.zsh"
    dest: "{{.vars.home}}/.p10k.zsh"
    force: true

  - src: "conf/vimrc"
    dest: "{{.vars.home}}/.vimrc"
    force: true

tasks:
  - id: change_shell
    deps: [zsh, oh-my-zsh]
    check: '[ "$SHELL" = "$(which zsh)" ]'
    on: 
      fail: run
    run: "sudo chsh -s $(which zsh) $USER"

  - id: welcome_msg
    deps: [p10k, vim-plugins]
    run: "echo 'üéâ Environment Setup for Kie-Chi Complete! Please relogin.'"

  - id: shortcut_tilix_quake
    deps: [tilix]
    check: |
      gsettings get org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom-tilix-quake/ command | grep -Fq "'tilix --quake'" && \
      gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings | grep -Fq "custom-tilix-quake"
    run: |
      SCHEMA="org.gnome.settings-daemon.plugins.media-keys"
      KEY_PATH="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom-tilix-quake/"

      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} name "Tilix Quake"
      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} command "tilix --quake"
      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} binding "F12"

      CURRENT_LIST=$(gsettings get $SCHEMA custom-keybindings)

      if ! echo "$CURRENT_LIST" | grep -Fq "$KEY_PATH"; then
        if [ "$CURRENT_LIST" = "@as []" ] || [ "$CURRENT_LIST" = "[]" ]; then
           NEW_LIST="['$KEY_PATH']"
        else
           NEW_LIST=$(echo "$CURRENT_LIST" | sed "s|]$|, '$KEY_PATH']|")
        fi
        gsettings set $SCHEMA custom-keybindings "$NEW_LIST"
      fi

  - id: shortcut_tilix_normal
    deps: [tilix]
    check: |
      gsettings get org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom-tilix-normal/ command | grep -Fq "'tilix'" && \
      gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings | grep -Fq "custom-tilix-normal"
    run: |
      SCHEMA="org.gnome.settings-daemon.plugins.media-keys"
      KEY_PATH="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom-tilix-normal/"

      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} name "Tilix"
      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} command "tilix"
      gsettings set ${SCHEMA}.custom-keybinding:${KEY_PATH} binding "<Control><Alt>t"

      CURRENT_LIST=$(gsettings get $SCHEMA custom-keybindings)

      if ! echo "$CURRENT_LIST" | grep -Fq "$KEY_PATH"; then
        if [ "$CURRENT_LIST" = "@as []" ] || [ "$CURRENT_LIST" = "[]" ]; then
           NEW_LIST="['$KEY_PATH']"
        else
           NEW_LIST=$(echo "$CURRENT_LIST" | sed "s|]$|, '$KEY_PATH']|")
        fi
        gsettings set $SCHEMA custom-keybindings "$NEW_LIST"
      fi
  - id: generate_ssh_key
    deps: [git]
    check: "[ -f {{.vars.home}}/.ssh/id_ed25519 ]"
    run: |
      echo "Generating SSH Key for {{.vars.email}}..."
      mkdir -p {{.vars.home}}/.ssh
      chmod 700 {{.vars.home}}/.ssh
      ssh-keygen -t ed25519 -C "{{.vars.email}}" -f {{.vars.home}}/.ssh/id_ed25519 -N ""

      eval "$(ssh-agent -s)"
      ssh-add {{.vars.home}}/.ssh/id_ed25519

      echo "--------------------------------------------------------"
      echo "PUBLIC KEY GENERATED:"
      echo "--------------------------------------------------------"
      cat {{.vars.home}}/.ssh/id_ed25519.pub
      echo "--------------------------------------------------------"

  - id: remove_snap
    check: "! command -v snap"
    run: |
      echo "Starting Snap Removal..."
      if command -v snap &> /dev/null; then
          echo "Removing installed snaps (This may take a while)..."
          
          for i in {1..3}; do
              LANG=C snap list | awk 'NR>1 {print $1}' | while read -r snapname; do
                  sudo snap remove --purge "$snapname" 2>/dev/null || true
              done
          done
      fi

      echo "All user snaps removed. Stopping services..."

      sudo systemctl stop snapd.socket || true
      sudo systemctl stop snapd.service || true
      sudo systemctl disable snapd.socket || true
      sudo systemctl disable snapd.service || true
      
      echo "Purging snapd via APT..."
      sudo apt-get autoremove --purge -y snapd gnome-software-plugin-snap
      
      rm -rf ~/snap
      sudo rm -rf /var/cache/snapd
      sudo rm -rf /var/lib/snapd
      
      echo "Snap Removed Successfully." 
  - id: block_snap
    deps: [remove_snap]
    check: "[ -f /etc/apt/preferences.d/nosnap.pref ]"
    run: |
      echo "Blocking Snap re-installation..."
      cat <<EOF | sudo tee /etc/apt/preferences.d/nosnap.pref
      Package: snapd
      Pin: release a=*
      Pin-Priority: -1
      EOF
      echo "Snap is now blocked via APT pinning."
  - id: firefox
    deps: [block_snap]
    check: "dpkg -l | grep firefox | grep -v snap"
    run: |
      sudo add-apt-repository -y ppa:mozillateam/ppa
      cat <<EOF | sudo tee /etc/apt/preferences.d/mozilla-firefox
      Package: *
      Pin: release o=LP-PPA-mozillateam
      Pin-Priority: 1001
      EOF
      sudo apt-get update
      sudo apt-get install -y firefox
